# BatchTransfer 智能合约部署文档

## 项目概述

BatchTransfer 是一个基于以太坊的批量转账智能合约，支持一次性向多个地址转账 ETH。项目使用 Foundry 框架进行开发、测试和部署。

## 环境要求

### 必需工具
- **Foundry**: Solidity 开发框架
- **Git**: 版本控制
- **Node.js**: (可选，用于前端集成)

### 安装 Foundry

```bash
# 安装 Foundry
curl -L https://foundry.paradigm.xyz | bash
foundryup

# 验证安装
forge --version
cast --version
anvil --version
```

## 项目设置

### 1. 克隆项目

```bash
git clone <repository-url>
cd batch-transfer/contracts
```

### 2. 安装依赖

```bash
# 使用 Makefile
make install

# 或者手动安装
forge install foundry-rs/forge-std
forge install OpenZeppelin/openzeppelin-contracts
```

### 3. 环境配置

复制环境变量模板并配置：

```bash
cp .env.example .env
```

编辑 `.env` 文件，填入以下信息：

```bash
# Ethereum RPC URLs
MAINNET_RPC_URL=https://eth-mainnet.g.alchemy.com/v2/YOUR_ALCHEMY_API_KEY
SEPOLIA_RPC_URL=https://eth-sepolia.g.alchemy.com/v2/YOUR_ALCHEMY_API_KEY

# API Keys
ALCHEMY_API_KEY=your_alchemy_api_key_here
ETHERSCAN_API_KEY=your_etherscan_api_key_here

# Private Key (不要提交到版本控制)
PRIVATE_KEY=your_private_key_here

# Contract Addresses (部署后填入)
BATCH_TRANSFER_ADDRESS_MAINNET=
BATCH_TRANSFER_ADDRESS_SEPOLIA=
```

**⚠️ 安全提醒**: 
- 永远不要将私钥提交到版本控制系统
- 使用测试网络进行开发和测试
- 主网部署前请充分测试

## 编译

### 编译合约

```bash
# 使用 Makefile
make build

# 或者直接使用 forge
forge build
```

### 编译输出

编译成功后，产物将生成在 `out/` 目录：
- `out/BatchTransfer.sol/BatchTransfer.json`: 包含字节码、ABI、元数据
- 其他依赖合约的编译产物

### 检查编译

```bash
# 检查合约大小
forge build --sizes

# 生成 gas 报告
forge test --gas-report
```

## 测试

### 运行测试

```bash
# 基础测试
make test

# 详细输出测试
forge test -vvv

# 带 gas 报告的测试
make test-gas

# 运行特定测试
forge test --match-test testBatchTransferSuccess -vvv
```

### 测试覆盖率

```bash
# 生成覆盖率报告
forge coverage

# 生成 HTML 覆盖率报告
forge coverage --report lcov
genhtml lcov.info -o coverage
```

### 测试内容

项目包含以下测试用例：
- 正常批量转账测试
- 边界条件测试（空数组、超过最大接收者数量等）
- 安全性测试（重入攻击防护、权限控制等）
- Gas 优化测试
- 错误处理测试

## 部署

### 测试网部署 (Sepolia)

1. **确保测试网 ETH 余额充足**
   ```bash
   # 检查余额
   cast balance <your-address> --rpc-url $SEPOLIA_RPC_URL
   ```

2. **部署到 Sepolia**
   ```bash
   make deploy-sepolia
   ```

3. **验证合约**
   ```bash
   make verify-sepolia
   ```

### 主网部署

**⚠️ 主网部署前检查清单**:
- [ ] 所有测试通过
- [ ] 代码审计完成
- [ ] Gas 费用预算充足
- [ ] 部署参数确认无误
- [ ] 备份私钥和助记词

1. **部署到主网**
   ```bash
   make deploy-mainnet
   ```

2. **验证合约**
   ```bash
   make verify-mainnet
   ```

### 手动部署

如果需要更精细的控制，可以手动执行部署：

```bash
# 部署到指定网络
forge script script/Deploy.s.sol:DeployScript \
    --rpc-url $SEPOLIA_RPC_URL \
    --broadcast \
    --verify \
    --etherscan-api-key $ETHERSCAN_API_KEY
```

### 部署后验证

1. **检查合约地址**
   ```bash
   # 查看部署记录
   cat broadcast/Deploy.s.sol/11155111/run-latest.json
   ```

2. **测试合约功能**
   ```bash
   # 检查合约所有者
   cast call <contract-address> "owner()" --rpc-url $SEPOLIA_RPC_URL
   
   # 检查最大接收者数量
   cast call <contract-address> "MAX_RECIPIENTS()" --rpc-url $SEPOLIA_RPC_URL
   ```

## 合约交互

### 使用 Cast 进行交互

```bash
# 设置合约地址
CONTRACT_ADDRESS=<deployed-contract-address>

# 查看合约信息
cast call $CONTRACT_ADDRESS "totalTransactions()" --rpc-url $SEPOLIA_RPC_URL

# 执行批量转账
cast send $CONTRACT_ADDRESS \
    "batchTransfer(address[],uint256[])" \
    "[0x742d35Cc6634C0532925a3b8D4C9db96c4b4d8b6,0x8ba1f109551bD432803012645Hac136c5C1515]" \
    "[1000000000000000000,2000000000000000000]" \
    --value 3000000000000000000 \
    --private-key $PRIVATE_KEY \
    --rpc-url $SEPOLIA_RPC_URL
```

### Gas 费用估算

```bash
# 估算 gas 费用
cast estimate $CONTRACT_ADDRESS \
    "batchTransfer(address[],uint256[])" \
    "[0x742d35Cc6634C0532925a3b8D4C9db96c4b4d8b6]" \
    "[1000000000000000000]" \
    --value 1000000000000000000 \
    --rpc-url $SEPOLIA_RPC_URL
```

## 常用命令

### Makefile 命令总览

```bash
# 开发命令
make install     # 安装依赖
make build       # 编译合约
make test        # 运行测试
make test-gas    # 运行测试并显示 gas 报告
make clean       # 清理编译产物

# 部署命令
make deploy-sepolia  # 部署到 Sepolia 测试网
make deploy-mainnet  # 部署到以太坊主网

# 验证命令
make verify-sepolia  # 在 Sepolia 上验证合约
make verify-mainnet  # 在主网上验证合约

# 代码质量
make format      # 格式化代码
make format-check # 检查代码格式
make analyze     # 静态分析
make docs        # 生成文档
```

### Forge 常用命令

```bash
# 项目管理
forge init          # 初始化新项目
forge install       # 安装依赖
forge update        # 更新依赖
forge remove        # 移除依赖

# 编译和构建
forge build         # 编译合约
forge clean         # 清理编译产物
forge fmt           # 格式化代码

# 测试
forge test          # 运行测试
forge coverage      # 生成覆盖率报告
forge snapshot      # 生成 gas 快照

# 部署和验证
forge script        # 运行部署脚本
forge verify-contract # 验证合约

# 工具
forge inspect       # 检查合约信息
forge tree          # 显示依赖树
```

## 故障排除

### 常见问题

1. **编译失败**
   ```bash
   # 清理并重新编译
   make clean
   make build
   ```

2. **测试失败**
   ```bash
   # 运行详细测试查看错误
   forge test -vvv
   ```

3. **部署失败**
   - 检查网络连接
   - 确认私钥和 RPC URL 正确
   - 检查账户余额是否充足
   - 验证 gas 价格设置

4. **验证失败**
   - 确认 Etherscan API 密钥正确
   - 检查合约地址是否正确
   - 等待几分钟后重试

### 调试技巧

```bash
# 使用 console.log 调试
# 在合约中添加：
# import "forge-std/console.sol";
# console.log("Debug message", variable);

# 运行本地节点进行调试
anvil

# 在另一个终端部署到本地网络
forge script script/Deploy.s.sol --rpc-url http://localhost:8545 --broadcast
```

## 安全注意事项

1. **私钥安全**
   - 使用硬件钱包进行主网部署
   - 不要在代码中硬编码私钥
   - 定期轮换测试网私钥

2. **合约安全**
   - 进行充分的单元测试
   - 考虑进行专业安全审计
   - 使用 OpenZeppelin 等经过验证的库

3. **部署安全**
   - 在测试网充分测试后再部署主网
   - 使用多重签名钱包管理合约
   - 设置合理的权限控制

## 监控和维护

### 合约监控

```bash
# 监控合约事件
cast logs --address $CONTRACT_ADDRESS --rpc-url $SEPOLIA_RPC_URL

# 查看交易历史
cast tx <transaction-hash> --rpc-url $SEPOLIA_RPC_URL
```

### 升级策略

当前合约不支持升级，如需更新功能：
1. 部署新版本合约
2. 迁移必要的状态数据
3. 更新前端应用配置
4. 通知用户使用新合约地址

## 参考资源

- [Foundry 官方文档](https://book.getfoundry.sh/)
- [OpenZeppelin 合约库](https://docs.openzeppelin.com/contracts/)
- [Solidity 官方文档](https://docs.soliditylang.org/)
- [以太坊开发者资源](https://ethereum.org/developers/)

---

**最后更新**: 2024年
**文档版本**: 1.0
**维护者**: WebThree Team